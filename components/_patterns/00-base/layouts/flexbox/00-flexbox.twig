{% set flexbox_base_class = flexbox_base_class|default('flexbox') %}
{# This var is set to prevent add_attributes griping about an empty var #}
{% set flexbox_attributes = flexbox_attributes|default([]) %}

{% if flexbox_modifiers_additional %}
  {% set flexbox_extra = bem2('item', (flexbox_modifiers_additional), 'flexbox') %}
{% endif %}

{% set natural_flexbox_bem = bem2(flexbox_base_class, (flexbox_modifiers), flexbox_blockname, (flexbox_extra)) %}
{% set finished_flexbox_bem = {'class' : natural_flexbox_bem} %}


<div
  {#{ bem(flexbox_base_class, (flexbox_modifiers), flexbox_blockname, flexbox_extra) }#}
  {{ add_attributes(finished_flexbox_bem) }}
  {{ add_attributes(flexbox_attributes) }}
>
  {% for flexbox_item in flexbox_items %}

    {# ***** Start Patternlab Section 1 ***** #}
    {# Image #}
    {%- if flexbox_item.img_attributes -%}
      {% set flexbox_item %}
        {%- include "@atoms/04-images/00-image/00-image.twig" with {
          "img_attributes": flexbox_item.img_attributes,
          "img_blockname": card_base_class,
        } -%}
      {% endset %}
    {%- endif -%}
    {# End Image #}
    {# Title #}
    {%- if flexbox_item.title -%}
      {% set flexbox_item %}
        {%- if flexbox_item.link_attributes -%}
          {%- embed "@atoms/01-links/link/link.twig" with {
            "link_attributes": flexbox_item.link_attributes,
            "link_modifiers": flexbox_item.link_modifiers,
            "link_blockname": card_base_class,
          } -%}
            {%- block link_content -%}
              {%- include "@atoms/03-text/01-heading/_heading.twig" with {
                "heading_level": 2,
                "heading_content": flexbox_item.title,
                "heading_modifiers": flexbox_item.modifiers,
                "heading_blockname": card_base_class,
              } -%}
            {%- endblock -%}
          {%- endembed -%}
        {%- else -%}
          {%- include "@atoms/03-text/01-heading/_heading.twig" with {
            "heading_level": 2,
            "heading_content": flexbox_item.title,
            "heading_modifiers": flexbox_item.modifiers,
            "heading_blockname": card_base_class,
          } -%}
        {%- endif -%}
      {% endset %}
    {%- endif -%}
    {# End Title #}
    {# Subtitle #}
    {%- if flexbox_item.subtitle -%}
      {% set flexbox_item %}
        {%- if flexbox_item.link_attributes -%}
          {%- embed "@atoms/01-links/link/link.twig" with {
            "link_attributes": flexbox_item.link_attributes,
            "link_modifiers": flexbox_item.link_modifiers,
            "link_blockname": card_base_class,
          } -%}
            {%- block link_content -%}
              {%- include "@atoms/03-text/01-heading/_heading.twig" with {
                "heading_level": 3,
                "heading_content": flexbox_item.subtitle,
                "heading_modifiers": flexbox_item.modifiers,
                "heading_blockname": card_base_class,
              } -%}
            {%- endblock -%}
          {%- endembed -%}
        {%- else -%}
          {%- include "@atoms/03-text/01-heading/_heading.twig" with {
            "heading_level": 3,
            "heading_content": flexbox_item.subtitle,
            "heading_modifiers": flexbox_item.modifiers,
            "heading_blockname": card_base_class,
          } -%}
        {%- endif -%}
      {% endset %}
    {%- endif -%}
    {# End Title #}
    {# Body #}
    {%- if flexbox_item.body -%}
      {% set flexbox_item %}
        {%- include "@atoms/03-text/02-paragraph/paragraph.twig" with {
          "paragraph_content": flexbox_item.body,
          "paragraph_modifiers": flexbox_item.modifiers,
          "paragraph_blockname": card_base_class,
        } -%}
      {% endset %}
    {%- endif -%}
    {# End Body #}
    {# Button #}
    {%- if flexbox_item.button_attributes -%}
      {% set flexbox_item %}
        {%- include "@atoms/02-form_elements/01-button/00-button.twig" with {
          "button_content": flexbox_item.button,
          "button_attributes": flexbox_item.button_attributes,
          "button_modifiers": flexbox_item.modifiers,
          "button_blockname": card_base_class,
        } -%}
      {% endset %}
    {%- endif -%}
    {# End Button #}
    {# Link #}
    {%- if flexbox_item.link_attributes -%}
      {% set flexbox_item %}
        {%- include "@atoms/01-links/link/link.twig" with {
          "link_content": flexbox_item.link,
          "link_attributes": flexbox_item.link_attributes,
          "link_modifiers": flexbox_item.link_modifiers,
          "link_blockname": card_base_class,
        } -%}
      {% endset %}
    {%- endif -%}
    {# End Link #}
    {# ***** End Patternlab Section 1 ***** #}

    {# ***** Start Patternlab Section 2 ***** #}
    {# using card.twig for now #}
    {%- if flexbox_item.flexbox_section_items -%}
      {% set flexbox_section_modifiers =  flexbox_item.flexbox_section_modifiers %}
      {% set flexbox_section_items =  flexbox_item.flexbox_section_items %}
      {% set flexbox_section_flexbox_extra =  flexbox_item.flexbox_section_flexbox_extra %}
    {# using nested-flexbox.twig #}
      {% set flexbox_section_modifiers =  flexbox_item.flexbox_section_modifiers %}
      {% set flexbox_section_items =  flexbox_item.flexbox_section_items %}
      {% set flexbox_section_modifiers_additional =  flexbox_item.flexbox_section_modifiers_additional %}

    {% else %}
      {# FOR DRUPAL when using card.twig #}
      {% set flexbox_section_items =  flexbox_item %}
    {%- endif -%}
    {# ***** End Patternlab Section 2 ***** #}

    {% block flexbox_block %}

      {% include "@base/layouts/flexbox-item/_flexbox-item.twig" with {
        "flexbox_item_blockname": flexbox_blockname|default(flexbox_base_class),
        "flexbox_item_modifiers": flexbox_modifiers,
        "flexbox_item_content": flexbox_item,
        "flexbox_item_modifiers_additional": flexbox_section_modifiers,
      } %}

    {% endblock flexbox_block %}
  {% endfor %}
</div>
